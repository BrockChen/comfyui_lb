<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComfyUI è´Ÿè½½å‡è¡¡å™¨</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e14;
            --bg-secondary: #131920;
            --bg-card: #1a2028;
            --bg-card-hover: #222a35;
            --border: #2a3545;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --accent-cyan: #39c5bb;
            --accent-green: #3fb950;
            --accent-yellow: #d29922;
            --accent-red: #f85149;
            --accent-blue: #58a6ff;
            --accent-purple: #a371f7;
            --accent-orange: #f0883e;
            --gradient-start: #39c5bb;
            --gradient-end: #58a6ff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: 
                radial-gradient(ellipse 80% 50% at 50% -20%, rgba(57, 197, 187, 0.15), transparent),
                radial-gradient(ellipse 60% 40% at 100% 0%, rgba(88, 166, 255, 0.1), transparent);
            pointer-events: none;
            z-index: -1;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 24px; }

        /* å¤´éƒ¨ */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .logo { display: flex; align-items: center; gap: 16px; }

        .logo-icon {
            width: 48px; height: 48px;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; font-weight: 700;
            color: var(--bg-primary);
            font-family: 'JetBrains Mono', monospace;
        }

        .logo h1 {
            font-size: 24px; font-weight: 600;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo p { font-size: 13px; color: var(--text-secondary); }

        .header-actions { display: flex; gap: 12px; align-items: center; }
        .refresh-info { font-size: 12px; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }

        /* æŒ‰é’® */
        .btn {
            padding: 10px 20px;
            border: none; border-radius: 8px;
            font-size: 14px; font-weight: 500;
            cursor: pointer; transition: all 0.2s ease;
            display: flex; align-items: center; gap: 8px;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: var(--bg-primary);
        }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 20px rgba(57, 197, 187, 0.3); }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        .btn-secondary:hover { background: var(--bg-card-hover); border-color: var(--accent-cyan); }

        .btn-sm { padding: 6px 12px; font-size: 12px; }

        .btn-icon {
            width: 36px; height: 36px;
            border: none; border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s ease;
            font-size: 16px;
        }
        .btn-icon:hover { background: var(--accent-cyan); color: var(--bg-primary); }
        .btn-icon.danger:hover { background: var(--accent-red); }

        /* æ ‡ç­¾é¡µå¯¼èˆª */
        .tab-nav {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            background: var(--bg-secondary);
            padding: 4px;
            border-radius: 12px;
            width: fit-content;
        }

        .tab-btn {
            padding: 10px 24px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-btn:hover { color: var(--text-primary); background: var(--bg-card); }
        .tab-btn.active {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: var(--bg-primary);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--card-accent), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover::before { opacity: 1; }
        .stat-card:hover { transform: translateY(-2px); border-color: var(--card-accent); }

        .stat-card.cyan { --card-accent: var(--accent-cyan); }
        .stat-card.green { --card-accent: var(--accent-green); }
        .stat-card.yellow { --card-accent: var(--accent-yellow); }
        .stat-card.red { --card-accent: var(--accent-red); }
        .stat-card.blue { --card-accent: var(--accent-blue); }
        .stat-card.purple { --card-accent: var(--accent-purple); }
        .stat-card.orange { --card-accent: var(--accent-orange); }

        .stat-label { font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; }
        .stat-value {
            font-size: 32px; font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--card-accent);
            line-height: 1;
        }

        /* é¢æ¿ */
        .panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 24px;
        }

        .panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-size: 15px; font-weight: 600;
            display: flex; align-items: center; gap: 10px;
        }

        .panel-title .icon {
            width: 28px; height: 28px;
            background: var(--bg-secondary);
            border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px;
        }

        .panel-body { padding: 16px 20px; }

        /* åˆ—è¡¨é¡¹ */
        .list-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px 18px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .list-item:hover { border-color: var(--accent-cyan); background: var(--bg-card-hover); }
        .list-item:last-child { margin-bottom: 0; }

        .list-item-info h4 { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
        .list-item-info p { font-size: 12px; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }

        .list-item-actions { display: flex; gap: 8px; }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-dot {
            width: 10px; height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-dot.healthy { background: var(--accent-green); box-shadow: 0 0 8px var(--accent-green); }
        .status-dot.unhealthy { background: var(--accent-red); box-shadow: 0 0 8px var(--accent-red); }
        .status-dot.unknown { background: var(--text-muted); }

        /* è¡¨å• */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-group label { font-size: 12px; color: var(--text-secondary); }

        .form-group input, .form-group select {
            padding: 10px 14px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px rgba(57, 197, 187, 0.1);
        }

        .form-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 16px; }

        .form-inline {
            display: none;
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            background: var(--bg-secondary);
        }
        .form-inline.show { display: block; }

        /* æ ‡ç­¾ */
        .tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
        }

        .tag-cyan { background: rgba(57, 197, 187, 0.15); color: var(--accent-cyan); }
        .tag-green { background: rgba(63, 185, 80, 0.15); color: var(--accent-green); }
        .tag-blue { background: rgba(88, 166, 255, 0.15); color: var(--accent-blue); }
        .tag-yellow { background: rgba(210, 153, 34, 0.15); color: var(--accent-yellow); }
        .tag-red { background: rgba(248, 81, 73, 0.15); color: var(--accent-red); }
        .tag-purple { background: rgba(163, 113, 247, 0.15); color: var(--accent-purple); }
        .tag-orange { background: rgba(240, 136, 62, 0.15); color: var(--accent-orange); }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }
        .empty-state .icon { font-size: 40px; margin-bottom: 12px; opacity: 0.5; }

        /* ç½‘æ ¼å¸ƒå±€ */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        @media (max-width: 900px) { .grid-2 { grid-template-columns: 1fr; } }

        /* é˜Ÿåˆ—é¡¹ */
        .queue-badge {
            background: var(--bg-secondary);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-cyan);
        }

        .task-list { max-height: 250px; overflow-y: auto; }
        .task-list::-webkit-scrollbar { width: 6px; }
        .task-list::-webkit-scrollbar-track { background: var(--bg-secondary); border-radius: 3px; }
        .task-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        /* ç­–ç•¥æŒ‰é’® */
        .strategy-selector { display: flex; gap: 8px; flex-wrap: wrap; }

        .strategy-btn {
            padding: 8px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .strategy-btn:hover { border-color: var(--accent-cyan); color: var(--text-primary); }
        .strategy-btn.active { background: var(--accent-cyan); color: var(--bg-primary); border-color: var(--accent-cyan); }

        /* KongçŠ¶æ€ */
        .kong-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .kong-status.connected { border-left: 3px solid var(--accent-green); }
        .kong-status.disconnected { border-left: 3px solid var(--accent-red); }

        /* åŠ¨ç”» */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-in { animation: slideIn 0.3s ease forwards; }

        /* æ¶ˆæ¯æç¤º */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 14px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            display: none;
            z-index: 1000;
        }
        .toast.show { display: block; animation: slideIn 0.3s ease; }
        .toast.success { border-left: 3px solid var(--accent-green); }
        .toast.error { border-left: 3px solid var(--accent-red); }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <header>
            <div class="logo">
                <div class="logo-icon">LB</div>
                <div>
                    <h1>ComfyUI è´Ÿè½½å‡è¡¡å™¨</h1>
                    <p>å¤šå®ä¾‹ä»»åŠ¡åˆ†å‘ä¸é˜Ÿåˆ—ç®¡ç†</p>
                </div>
            </div>
            <div class="header-actions">
                <span class="refresh-info">è‡ªåŠ¨åˆ·æ–°: <span id="refresh-countdown">5</span>s</span>
                <button class="btn btn-secondary" onclick="refreshAll()">ğŸ”„ åˆ·æ–°</button>
            </div>
        </header>

        <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
        <div class="tab-nav">
            <button class="tab-btn active" data-tab="dashboard">ğŸ“Š ä»ªè¡¨ç›˜</button>
            <button class="tab-btn" data-tab="backends">ğŸ–¥ï¸ åç«¯ç®¡ç†</button>
            <button class="tab-btn" data-tab="kong">ğŸ¦ Kong ç½‘å…³</button>
        </div>

        <!-- ä»ªè¡¨ç›˜ -->
        <div id="tab-dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card cyan">
                    <div class="stat-label">ğŸ“Š æ€»åç«¯æ•°</div>
                    <div class="stat-value" id="stat-total">-</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-label">âœ… å¥åº·åç«¯</div>
                    <div class="stat-value" id="stat-healthy">-</div>
                </div>
                <div class="stat-card blue">
                    <div class="stat-label">ğŸ’¤ ç©ºé—²åç«¯</div>
                    <div class="stat-value" id="stat-idle">-</div>
                </div>
                <div class="stat-card yellow">
                    <div class="stat-label">â³ ç­‰å¾…é˜Ÿåˆ—</div>
                    <div class="stat-value" id="stat-pending">-</div>
                </div>
                <div class="stat-card purple">
                    <div class="stat-label">ğŸš€ è¿›è¡Œä¸­</div>
                    <div class="stat-value" id="stat-dispatched">-</div>
                </div>
            </div>

            <div class="grid-2">
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title"><span class="icon">âš™ï¸</span> è°ƒåº¦ç­–ç•¥</div>
                    </div>
                    <div class="panel-body">
                        <div class="strategy-selector" id="strategy-selector">
                            <button class="strategy-btn" data-strategy="least_busy">æœ€å°‘å¿™ç¢Œ</button>
                            <button class="strategy-btn" data-strategy="round_robin">è½®è¯¢</button>
                            <button class="strategy-btn" data-strategy="weighted">åŠ æƒ</button>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title"><span class="icon">ğŸ“‹</span> ä»»åŠ¡é˜Ÿåˆ—</div>
                    </div>
                    <div class="panel-body">
                        <div style="margin-bottom: 16px;">
                            <span style="color: var(--text-secondary); font-size: 13px;">ç­‰å¾…åˆ†å‘</span>
                            <span class="queue-badge" id="pending-count">0</span>
                        </div>
                        <div class="task-list" id="pending-tasks">
                            <div class="empty-state"><p>æš‚æ— ç­‰å¾…ä»»åŠ¡</p></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åç«¯ç®¡ç† -->
        <div id="tab-backends" class="tab-content">
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title"><span class="icon">ğŸ–¥ï¸</span> åç«¯å®ä¾‹</div>
                    <button class="btn btn-secondary btn-sm" onclick="toggleForm('backend-form')">â• æ·»åŠ åç«¯</button>
                </div>
                <div class="form-inline" id="backend-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>åç§°</label>
                            <input type="text" id="backend-name" placeholder="comfy-3">
                        </div>
                        <div class="form-group">
                            <label>åœ°å€</label>
                            <input type="text" id="backend-host" placeholder="127.0.0.1" value="127.0.0.1">
                        </div>
                        <div class="form-group">
                            <label>ç«¯å£</label>
                            <input type="number" id="backend-port" placeholder="8190">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-secondary btn-sm" onclick="toggleForm('backend-form')">å–æ¶ˆ</button>
                        <button class="btn btn-primary btn-sm" onclick="addBackend()">æ·»åŠ </button>
                    </div>
                </div>
                <div class="panel-body" id="backend-list">
                    <div class="empty-state"><div class="icon">â³</div><p>åŠ è½½ä¸­...</p></div>
                </div>
            </div>
        </div>

        <!-- Kong ç½‘å…³ -->
        <div id="tab-kong" class="tab-content">
            <div class="kong-status disconnected" id="kong-status">
                <span>ğŸ¦</span>
                <span id="kong-status-text">æœªè¿æ¥</span>
            </div>

            <!-- Kong ç»Ÿè®¡ -->
            <div class="stats-grid" id="kong-stats">
                <div class="stat-card orange">
                    <div class="stat-label">ğŸ”Œ Services</div>
                    <div class="stat-value" id="kong-services-count">-</div>
                </div>
                <div class="stat-card blue">
                    <div class="stat-label">ğŸ›¤ï¸ Routes</div>
                    <div class="stat-value" id="kong-routes-count">-</div>
                </div>
                <div class="stat-card purple">
                    <div class="stat-label">ğŸ”Œ Plugins</div>
                    <div class="stat-value" id="kong-plugins-count">-</div>
                </div>
                <div class="stat-card cyan">
                    <div class="stat-label">ğŸ‘¤ Consumers</div>
                    <div class="stat-value" id="kong-consumers-count">-</div>
                </div>
            </div>

            <div class="grid-2">
                <!-- Services -->
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title"><span class="icon">ğŸ”Œ</span> Services</div>
                        <button class="btn btn-secondary btn-sm" onclick="toggleForm('service-form')">â• æ·»åŠ </button>
                    </div>
                    <div class="form-inline" id="service-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>åç§°</label>
                                <input type="text" id="service-name" placeholder="comfyui">
                            </div>
                            <div class="form-group">
                                <label>ä¸Šæ¸¸ URL</label>
                                <input type="text" id="service-url" placeholder="http://127.0.0.1:8188">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-secondary btn-sm" onclick="toggleForm('service-form')">å–æ¶ˆ</button>
                            <button class="btn btn-primary btn-sm" onclick="createService()">åˆ›å»º</button>
                        </div>
                    </div>
                    <div class="panel-body" id="kong-services-list">
                        <div class="empty-state"><p>æš‚æ— æœåŠ¡</p></div>
                    </div>
                </div>

                <!-- Routes -->
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title"><span class="icon">ğŸ›¤ï¸</span> Routes</div>
                        <button class="btn btn-secondary btn-sm" onclick="toggleForm('route-form')">â• æ·»åŠ </button>
                    </div>
                    <div class="form-inline" id="route-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>æœåŠ¡åç§°</label>
                                <select id="route-service"></select>
                            </div>
                            <div class="form-group">
                                <label>è·¯ç”±åç§°</label>
                                <input type="text" id="route-name" placeholder="comfyui-route">
                            </div>
                            <div class="form-group">
                                <label>è·¯å¾„</label>
                                <input type="text" id="route-path" placeholder="/comfyui">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-secondary btn-sm" onclick="toggleForm('route-form')">å–æ¶ˆ</button>
                            <button class="btn btn-primary btn-sm" onclick="createRoute()">åˆ›å»º</button>
                        </div>
                    </div>
                    <div class="panel-body" id="kong-routes-list">
                        <div class="empty-state"><p>æš‚æ— è·¯ç”±</p></div>
                    </div>
                </div>

                <!-- Consumers -->
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title"><span class="icon">ğŸ‘¤</span> Consumers</div>
                        <button class="btn btn-secondary btn-sm" onclick="toggleForm('consumer-form')">â• æ·»åŠ </button>
                    </div>
                    <div class="form-inline" id="consumer-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>ç”¨æˆ·å</label>
                                <input type="text" id="consumer-username" placeholder="user1">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-secondary btn-sm" onclick="toggleForm('consumer-form')">å–æ¶ˆ</button>
                            <button class="btn btn-primary btn-sm" onclick="createConsumer()">åˆ›å»º</button>
                        </div>
                    </div>
                    <div class="panel-body" id="kong-consumers-list">
                        <div class="empty-state"><p>æš‚æ— æ¶ˆè´¹è€…</p></div>
                    </div>
                </div>

                <!-- Plugins -->
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title"><span class="icon">ğŸ”Œ</span> Plugins</div>
                        <button class="btn btn-secondary btn-sm" onclick="toggleForm('plugin-form')">â• æ·»åŠ </button>
                    </div>
                    <div class="form-inline" id="plugin-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>æœåŠ¡</label>
                                <select id="plugin-service"></select>
                            </div>
                            <div class="form-group">
                                <label>æ’ä»¶ç±»å‹</label>
                                <select id="plugin-name">
                                    <option value="key-auth">key-auth</option>
                                    <option value="rate-limiting">rate-limiting</option>
                                    <option value="cors">cors</option>
                                    <option value="request-transformer">request-transformer</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-secondary btn-sm" onclick="toggleForm('plugin-form')">å–æ¶ˆ</button>
                            <button class="btn btn-primary btn-sm" onclick="createPlugin()">åˆ›å»º</button>
                        </div>
                    </div>
                    <div class="panel-body" id="kong-plugins-list">
                        <div class="empty-state"><p>æš‚æ— æ’ä»¶</p></div>
                    </div>
                </div>
            </div>

            <!-- API Keys -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title"><span class="icon">ğŸ”‘</span> API Keys</div>
                    <button class="btn btn-secondary btn-sm" onclick="toggleForm('key-form')">â• æ·»åŠ </button>
                </div>
                <div class="form-inline" id="key-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>æ¶ˆè´¹è€…</label>
                            <select id="key-consumer"></select>
                        </div>
                        <div class="form-group">
                            <label>Key (ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ)</label>
                            <input type="text" id="key-value" placeholder="my-secret-key">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-secondary btn-sm" onclick="toggleForm('key-form')">å–æ¶ˆ</button>
                        <button class="btn btn-primary btn-sm" onclick="createKey()">åˆ›å»º</button>
                    </div>
                </div>
                <div class="panel-body" id="kong-keys-list">
                    <div class="empty-state"><p>æš‚æ—  API Keys</p></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        const API_BASE = '';
        let refreshInterval = null;
        let countdown = 5;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initTabs();
            refreshAll();
            startAutoRefresh();
            initStrategyButtons();
        });

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function initTabs() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
                    if (btn.dataset.tab === 'kong') refreshKong();
                });
            });
        }

        // è‡ªåŠ¨åˆ·æ–°
        function startAutoRefresh() {
            countdown = 5;
            refreshInterval = setInterval(() => {
                countdown--;
                document.getElementById('refresh-countdown').textContent = countdown;
                if (countdown <= 0) { refreshAll(); countdown = 5; }
            }, 1000);
        }

        // åˆ·æ–°æ‰€æœ‰
        async function refreshAll() {
            await refreshDashboard();
            await refreshBackends();
            const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
            if (activeTab === 'kong') await refreshKong();
        }

        // åˆ·æ–°ä»ªè¡¨ç›˜
        async function refreshDashboard() {
            try {
                const [stats, tasks, scheduler] = await Promise.all([
                    fetch(`${API_BASE}/lb/stats`).then(r => r.json()),
                    fetch(`${API_BASE}/lb/tasks`).then(r => r.json()),
                    fetch(`${API_BASE}/lb/scheduler`).then(r => r.json())
                ]);
                updateStats(stats);
                updateTasks(tasks);
                updateStrategyButtons(scheduler.strategy);
            } catch (e) { console.error('åˆ·æ–°å¤±è´¥:', e); }
        }

        function updateStats(stats) {
            document.getElementById('stat-total').textContent = stats.total_backends;
            document.getElementById('stat-healthy').textContent = stats.healthy_backends;
            document.getElementById('stat-idle').textContent = stats.idle_backends;
            document.getElementById('stat-pending').textContent = stats.queue_status.pending;
            document.getElementById('stat-dispatched').textContent = stats.queue_status.dispatched;
        }

        function updateTasks(tasks) {
            document.getElementById('pending-count').textContent = tasks.pending.length;
            const container = document.getElementById('pending-tasks');
            if (tasks.pending.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>æš‚æ— ç­‰å¾…ä»»åŠ¡</p></div>';
            } else {
                container.innerHTML = tasks.pending.slice(0, 10).map(t => `
                    <div class="list-item">
                        <div class="list-item-info">
                            <p>${t.id.substring(0, 12)}...</p>
                        </div>
                        <span class="tag tag-cyan">ç­‰å¾…ä¸­</span>
                    </div>
                `).join('');
            }
        }

        // åˆ·æ–°åç«¯
        async function refreshBackends() {
            try {
                const stats = await fetch(`${API_BASE}/lb/stats`).then(r => r.json());
                const container = document.getElementById('backend-list');
                if (stats.backends.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ–¥ï¸</div><p>æš‚æ— åç«¯</p></div>';
                    return;
                }
                container.innerHTML = stats.backends.map(b => `
                    <div class="list-item animate-in">
                        <div class="list-item-info">
                            <h4><span class="status-dot ${b.status}"></span>${b.name}</h4>
                            <p>${b.base_url} Â· é˜Ÿåˆ—: ${b.queue_pending + b.queue_running}</p>
                        </div>
                        <div class="list-item-actions">
                            ${b.enabled
                                ? `<button class="btn-icon" onclick="toggleBackend('${b.name}', false)" title="ç¦ç”¨">â¸ï¸</button>`
                                : `<button class="btn-icon" onclick="toggleBackend('${b.name}', true)" title="å¯ç”¨">â–¶ï¸</button>`
                            }
                            <button class="btn-icon danger" onclick="removeBackend('${b.name}')" title="ç§»é™¤">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) { console.error(e); }
        }

        // ç­–ç•¥æŒ‰é’®
        function initStrategyButtons() {
            document.querySelectorAll('.strategy-btn').forEach(btn => {
                btn.addEventListener('click', () => setStrategy(btn.dataset.strategy));
            });
        }

        function updateStrategyButtons(current) {
            document.querySelectorAll('.strategy-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.strategy === current);
            });
        }

        async function setStrategy(strategy) {
            await fetch(`${API_BASE}/lb/scheduler/strategy/${strategy}`, { method: 'POST' });
            refreshDashboard();
        }

        // è¡¨å•åˆ‡æ¢
        function toggleForm(id) {
            document.getElementById(id).classList.toggle('show');
        }

        // åç«¯æ“ä½œ
        async function addBackend() {
            const name = document.getElementById('backend-name').value;
            const host = document.getElementById('backend-host').value;
            const port = parseInt(document.getElementById('backend-port').value);
            if (!name || !host || !port) return showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
            try {
                await fetch(`${API_BASE}/lb/backends`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, host, port, weight: 1, max_queue: 10, enabled: true })
                });
                toggleForm('backend-form');
                document.getElementById('backend-name').value = '';
                document.getElementById('backend-port').value = '';
                refreshBackends();
                showToast('åç«¯æ·»åŠ æˆåŠŸ', 'success');
            } catch (e) { showToast('æ·»åŠ å¤±è´¥', 'error'); }
        }

        async function removeBackend(name) {
            if (!confirm(`ç¡®å®šç§»é™¤ "${name}"?`)) return;
            await fetch(`${API_BASE}/lb/backends/${name}`, { method: 'DELETE' });
            refreshBackends();
            showToast('å·²ç§»é™¤', 'success');
        }

        async function toggleBackend(name, enable) {
            await fetch(`${API_BASE}/lb/backends/${name}/${enable ? 'enable' : 'disable'}`, { method: 'POST' });
            refreshBackends();
        }

        // ============ Kong ============
        async function refreshKong() {
            try {
                const status = await fetch(`${API_BASE}/kong/status`).then(r => r.json());
                const statusEl = document.getElementById('kong-status');
                const statusText = document.getElementById('kong-status-text');

                if (status.connected) {
                    statusEl.className = 'kong-status connected';
                    statusText.textContent = `å·²è¿æ¥ Â· ${status.admin_url} Â· Kong ${status.version || ''}`;
                    await Promise.all([refreshServices(), refreshRoutes(), refreshPlugins(), refreshConsumers()]);
                } else {
                    statusEl.className = 'kong-status disconnected';
                    statusText.textContent = `æœªè¿æ¥ Â· ${status.error || ''}`;
                }
            } catch (e) {
                document.getElementById('kong-status').className = 'kong-status disconnected';
                document.getElementById('kong-status-text').textContent = 'Kong ç®¡ç†æœªå¯ç”¨';
            }
        }

        async function refreshServices() {
            try {
                const data = await fetch(`${API_BASE}/kong/services`).then(r => r.json());
                const services = data.data || [];
                document.getElementById('kong-services-count').textContent = services.length;
                
                // æ›´æ–°æœåŠ¡ä¸‹æ‹‰æ¡†
                const serviceSelects = ['route-service', 'plugin-service'];
                serviceSelects.forEach(id => {
                    const select = document.getElementById(id);
                    if (select) {
                        select.innerHTML = services.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
                    }
                });

                const container = document.getElementById('kong-services-list');
                if (services.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>æš‚æ— æœåŠ¡</p></div>';
                } else {
                    container.innerHTML = services.map(s => `
                        <div class="list-item">
                            <div class="list-item-info">
                                <h4>${s.name}</h4>
                                <p>${s.host}:${s.port}</p>
                            </div>
                            <div class="list-item-actions">
                                <button class="btn-icon danger" onclick="deleteService('${s.id}')" title="åˆ é™¤">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (e) { console.error(e); }
        }

        async function refreshRoutes() {
            try {
                const data = await fetch(`${API_BASE}/kong/routes`).then(r => r.json());
                const routes = data.data || [];
                document.getElementById('kong-routes-count').textContent = routes.length;
                const container = document.getElementById('kong-routes-list');
                if (routes.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>æš‚æ— è·¯ç”±</p></div>';
                } else {
                    container.innerHTML = routes.map(r => `
                        <div class="list-item">
                            <div class="list-item-info">
                                <h4>${r.name || r.id.substring(0, 8)}</h4>
                                <p>${(r.paths || []).join(', ') || (r.hosts || []).join(', ')}</p>
                            </div>
                            <div class="list-item-actions">
                                <button class="btn-icon danger" onclick="deleteRoute('${r.id}')" title="åˆ é™¤">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (e) { console.error(e); }
        }

        async function refreshPlugins() {
            try {
                const data = await fetch(`${API_BASE}/kong/plugins`).then(r => r.json());
                const plugins = data.data || [];
                document.getElementById('kong-plugins-count').textContent = plugins.length;
                const container = document.getElementById('kong-plugins-list');
                if (plugins.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>æš‚æ— æ’ä»¶</p></div>';
                } else {
                    container.innerHTML = plugins.map(p => `
                        <div class="list-item">
                            <div class="list-item-info">
                                <h4>${p.name}</h4>
                                <p>${p.enabled ? 'âœ… å·²å¯ç”¨' : 'âŒ å·²ç¦ç”¨'}</p>
                            </div>
                            <div class="list-item-actions">
                                <button class="btn-icon danger" onclick="deletePlugin('${p.id}')" title="åˆ é™¤">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (e) { console.error(e); }
        }

        async function refreshConsumers() {
            try {
                const data = await fetch(`${API_BASE}/kong/consumers`).then(r => r.json());
                const consumers = data.data || [];
                document.getElementById('kong-consumers-count').textContent = consumers.length;
                
                // æ›´æ–°æ¶ˆè´¹è€…ä¸‹æ‹‰æ¡†
                const select = document.getElementById('key-consumer');
                if (select) {
                    select.innerHTML = consumers.map(c => `<option value="${c.username}">${c.username}</option>`).join('');
                }

                const container = document.getElementById('kong-consumers-list');
                if (consumers.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>æš‚æ— æ¶ˆè´¹è€…</p></div>';
                } else {
                    container.innerHTML = consumers.map(c => `
                        <div class="list-item">
                            <div class="list-item-info">
                                <h4>${c.username}</h4>
                                <p>${c.id.substring(0, 12)}...</p>
                            </div>
                            <div class="list-item-actions">
                                <button class="btn-icon" onclick="showKeys('${c.username}')" title="æŸ¥çœ‹å¯†é’¥">ğŸ”‘</button>
                                <button class="btn-icon danger" onclick="deleteConsumer('${c.username}')" title="åˆ é™¤">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    `).join('');
                }
                await refreshKeys();
            } catch (e) { console.error(e); }
        }

        async function refreshKeys() {
            try {
                const consumers = await fetch(`${API_BASE}/kong/consumers`).then(r => r.json());
                const allKeys = [];
                for (const c of (consumers.data || [])) {
                    try {
                        const keys = await fetch(`${API_BASE}/kong/consumers/${c.username}/key-auth`).then(r => r.json());
                        (keys.data || []).forEach(k => allKeys.push({ ...k, username: c.username }));
                    } catch (e) {}
                }
                const container = document.getElementById('kong-keys-list');
                if (allKeys.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>æš‚æ—  API Keys</p></div>';
                } else {
                    container.innerHTML = allKeys.map(k => `
                        <div class="list-item">
                            <div class="list-item-info">
                                <h4>ğŸ‘¤ ${k.username}</h4>
                                <p style="user-select: all;">ğŸ”‘ ${k.key}</p>
                            </div>
                            <div class="list-item-actions">
                                <button class="btn-icon" onclick="copyKey('${k.key}')" title="å¤åˆ¶">ğŸ“‹</button>
                                <button class="btn-icon danger" onclick="deleteKey('${k.username}', '${k.id}')" title="åˆ é™¤">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (e) { console.error(e); }
        }

        // Kong åˆ›å»ºæ“ä½œ
        async function createService() {
            const name = document.getElementById('service-name').value;
            const url = document.getElementById('service-url').value;
            if (!name || !url) return showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
            try {
                await fetch(`${API_BASE}/kong/services`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, url })
                });
                toggleForm('service-form');
                document.getElementById('service-name').value = '';
                document.getElementById('service-url').value = '';
                refreshServices();
                showToast('æœåŠ¡åˆ›å»ºæˆåŠŸ', 'success');
            } catch (e) { showToast('åˆ›å»ºå¤±è´¥: ' + e.message, 'error'); }
        }

        async function createRoute() {
            const service = document.getElementById('route-service').value;
            const name = document.getElementById('route-name').value;
            const path = document.getElementById('route-path').value;
            if (!service || !name || !path) return showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
            try {
                await fetch(`${API_BASE}/kong/services/${service}/routes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, paths: [path], strip_path: true })
                });
                toggleForm('route-form');
                document.getElementById('route-name').value = '';
                document.getElementById('route-path').value = '';
                refreshRoutes();
                showToast('è·¯ç”±åˆ›å»ºæˆåŠŸ', 'success');
            } catch (e) { showToast('åˆ›å»ºå¤±è´¥', 'error'); }
        }

        async function createConsumer() {
            const username = document.getElementById('consumer-username').value;
            if (!username) return showToast('è¯·è¾“å…¥ç”¨æˆ·å', 'error');
            try {
                await fetch(`${API_BASE}/kong/consumers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                toggleForm('consumer-form');
                document.getElementById('consumer-username').value = '';
                refreshConsumers();
                showToast('æ¶ˆè´¹è€…åˆ›å»ºæˆåŠŸ', 'success');
            } catch (e) { showToast('åˆ›å»ºå¤±è´¥', 'error'); }
        }

        async function createPlugin() {
            const service = document.getElementById('plugin-service').value;
            const name = document.getElementById('plugin-name').value;
            if (!service || !name) return showToast('è¯·é€‰æ‹©æœåŠ¡å’Œæ’ä»¶', 'error');
            try {
                await fetch(`${API_BASE}/kong/services/${service}/plugins`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, enabled: true })
                });
                toggleForm('plugin-form');
                refreshPlugins();
                showToast('æ’ä»¶åˆ›å»ºæˆåŠŸ', 'success');
            } catch (e) { showToast('åˆ›å»ºå¤±è´¥', 'error'); }
        }

        async function createKey() {
            const username = document.getElementById('key-consumer').value;
            const key = document.getElementById('key-value').value;
            if (!username) return showToast('è¯·é€‰æ‹©æ¶ˆè´¹è€…', 'error');
            try {
                await fetch(`${API_BASE}/kong/consumers/${username}/key-auth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(key ? { key } : {})
                });
                toggleForm('key-form');
                document.getElementById('key-value').value = '';
                refreshKeys();
                showToast('å¯†é’¥åˆ›å»ºæˆåŠŸ', 'success');
            } catch (e) { showToast('åˆ›å»ºå¤±è´¥', 'error'); }
        }

        // Kong åˆ é™¤æ“ä½œ
        async function deleteService(id) {
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤æœåŠ¡?')) return;
            await fetch(`${API_BASE}/kong/services/${id}`, { method: 'DELETE' });
            refreshServices();
            showToast('å·²åˆ é™¤', 'success');
        }

        async function deleteRoute(id) {
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤è·¯ç”±?')) return;
            await fetch(`${API_BASE}/kong/routes/${id}`, { method: 'DELETE' });
            refreshRoutes();
            showToast('å·²åˆ é™¤', 'success');
        }

        async function deletePlugin(id) {
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤æ’ä»¶?')) return;
            await fetch(`${API_BASE}/kong/plugins/${id}`, { method: 'DELETE' });
            refreshPlugins();
            showToast('å·²åˆ é™¤', 'success');
        }

        async function deleteConsumer(username) {
            if (!confirm(`ç¡®å®šåˆ é™¤æ¶ˆè´¹è€… "${username}"?`)) return;
            await fetch(`${API_BASE}/kong/consumers/${username}`, { method: 'DELETE' });
            refreshConsumers();
            showToast('å·²åˆ é™¤', 'success');
        }

        async function deleteKey(username, keyId) {
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤å¯†é’¥?')) return;
            await fetch(`${API_BASE}/kong/consumers/${username}/key-auth/${keyId}`, { method: 'DELETE' });
            refreshKeys();
            showToast('å·²åˆ é™¤', 'success');
        }

        function copyKey(key) {
            navigator.clipboard.writeText(key);
            showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        }

        // Toast æç¤º
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>

